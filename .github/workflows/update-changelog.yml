name: Update Changelog

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'changelog.mdx'
      - '.github/workflows/update-changelog.yml'

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update changelog
        run: |
          TODAY=$(date +%Y-%m-%d)

          # Get the commit message from this push (excluding changelog updates)
          COMMIT_MSG=$(git log --format="%s" -n 1 HEAD | grep -v "Auto-update changelog" || true)

          if [ -z "$COMMIT_MSG" ]; then
            echo "No commits to add to changelog"
            exit 0
          fi

          # Read current changelog
          CHANGELOG=$(cat changelog.mdx)

          # Check if today's date already exists
          if grep -q "date=\"$TODAY\"" changelog.mdx; then
            # Add to existing day's entry (insert after the opening Update tag)
            sed -i "s|<Update date=\"$TODAY\">|<Update date=\"$TODAY\">\n- $COMMIT_MSG|" changelog.mdx
          else
            # Create new entry after the frontmatter (after the closing ---)
            # Find line number of second --- (end of frontmatter)
            FRONTMATTER_END=$(grep -n "^---$" changelog.mdx | tail -1 | cut -d: -f1)

            # Create the new entry
            head -n "$FRONTMATTER_END" changelog.mdx > changelog_new.mdx
            echo "" >> changelog_new.mdx
            echo "<Update date=\"$TODAY\">" >> changelog_new.mdx
            echo "- $COMMIT_MSG" >> changelog_new.mdx
            echo "</Update>" >> changelog_new.mdx
            tail -n +$((FRONTMATTER_END + 1)) changelog.mdx >> changelog_new.mdx
            mv changelog_new.mdx changelog.mdx
          fi

          echo "Changelog updated with: $COMMIT_MSG"

      - name: Commit and push changelog
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add changelog.mdx
          git diff --staged --quiet || git commit -m "Auto-update changelog for $(date +%Y-%m-%d)"
          git push
